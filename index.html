<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مخزون المعدات الطبية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f0f4f8; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .tab-btn.active { border-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .login-card { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .engineer-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .engineer-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        /* --- Print Styles --- */
        @media print {
            body > *:not(#sticker-print-area) { display: none !important; }
            #sticker-print-area {
                visibility: visible !important; display: block !important;
                position: absolute; left: 0; top: 0;
                width: 100%; height: 100%;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            @page { size: 7cm 5cm; margin: 0; }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-cover bg-center p-4" style="background-image: url('https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');">
        <div class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
            <!-- Engineers Info -->
            <div class="space-y-4">
                <div class="engineer-card bg-white/80 login-card p-5 rounded-2xl shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-user-gear fa-3x text-blue-600 bg-blue-100 p-3 rounded-full"></i>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">المهندس كامل اليازجي</h3>
                        <p class="text-slate-600 font-medium" dir="ltr">+970 59 795 5844</p>
                    </div>
                </div>
                 <div class="engineer-card bg-white/80 login-card p-5 rounded-2xl shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-user-gear fa-3x text-green-600 bg-green-100 p-3 rounded-full"></i>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">المهندس خالد صبيح</h3>
                        <p class="text-slate-600 font-medium" dir="ltr">+972 59 286 1562</p>
                    </div>
                </div>
                 <div class="engineer-card bg-white/80 login-card p-5 rounded-2xl shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-user-gear fa-3x text-orange-600 bg-orange-100 p-3 rounded-full"></i>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">المهندس نعيم الحتو</h3>
                        <p class="text-slate-600 font-medium" dir="ltr">+972 56 709 0858</p>
                    </div>
                </div>
            </div>

            <!-- Login Form -->
            <div class="bg-white/80 login-card p-8 rounded-2xl shadow-2xl text-center">
                <img src="logo.png" alt="شعار" class="h-28 w-28 mx-auto mb-4">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">نظام إدارة المخزون</h2>
                <p class="text-slate-600 mb-6">الرجاء تسجيل الدخول للمتابعة</p>
                <form id="login-form">
                    <div class="mb-4">
                        <input type="text" id="username" placeholder="اسم المستخدم" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <input type="password" id="password" placeholder="كلمة المرور" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 mb-4 hidden">اسم المستخدم أو كلمة المرور غير صحيحة.</p>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                        دخول المهندسين
                    </button>
                </form>
                <div class="mt-4 flex items-center">
                    <hr class="flex-grow border-slate-300">
                    <span class="px-2 text-slate-500 text-sm">أو</span>
                    <hr class="flex-grow border-slate-300">
                </div>
                <button id="viewer-login-btn" class="w-full mt-4 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 transition-colors">
                    الدخول كمشرف
                </button>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto p-4 flex justify-between items-center">
                 <div class="flex items-center gap-3">
                    <img src="logo.png" alt="شعار" class="h-12 w-12">
                    <h1 class="text-xl font-bold text-slate-800">نظام إدارة المخزون</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-left">
                        <p class="font-bold" id="user-name-display"></p>
                        <p class="text-sm text-slate-500" id="user-role-display"></p>
                    </div>
                    <button id="logout-btn" class="text-slate-500 hover:text-red-600 transition-colors">
                        <i class="fa-solid fa-right-from-bracket fa-2x"></i>
                    </button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Tabs Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="dashboard-tab" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">الرئيسية</button>
                    <button id="list-tab" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">قائمة الأجهزة</button>
                </nav>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-view">
                <!-- Maintenance Today Section -->
                <section id="maintenance-today-section" class="mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center"><i class="fas fa-tools text-blue-500 ml-3"></i>أجهزة تحتاج صيانة اليوم</h3>
                        <div id="maintenance-today-list" class="space-y-3"></div>
                        <p id="no-maintenance-today" class="text-center py-4 text-slate-500 hidden">لا توجد أجهزة تحتاج إلى صيانة دورية اليوم.</p>
                    </div>
                </section>
                <!-- Stats & Charts -->
                <section id="stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></section>
                <section id="visuals" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"></section>
            </div>

            <!-- Device List Content -->
            <div id="list-view" class="hidden"></div>
        </main>
    </div>

    <!-- Modals (Edit, View, Delete) -->
    <div id="modals-container"></div>
    
    <!-- Sticker Print Area -->
    <div id="sticker-print-area" style="visibility: hidden; display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONFIG ---
    const AppState = {
        currentUser: null,
        devices: [],
        users: {
            kamel: { pass: '0000', name: 'المهندس كامل اليازجي', role: 'engineer' },
            khalid: { pass: '0000', name: 'المهندس خالد صبيح', role: 'engineer' },
            naem: { pass: '0000', name: 'المهندس نعيم الحتو', role: 'engineer' },
        },
        departments: [
            { code: 'EME', name: 'الطوارئ' }, { code: 'OPC', name: 'العيادات الخارجية' },
            { code: 'RAD', name: 'الأشعة' }, { code: 'LAB', name: 'المختبر' },
            { code: 'DEN', name: 'الأسنان' }, { code: 'OPE', name: 'العمليات' },
            { code: 'INP', name: 'قسم المبيت' }, { code: 'OBG', name: 'النساء والتوليد' },
            { code: 'NUR', name: 'الحضانة' }, { code: 'PHY', name: 'العلاج الطبيعي' },
            { code: 'LAU', name: 'المغسلة' }, { code: 'STE', name: 'التعقيم' },
            { code: 'WAR', name: 'المستودع' }
        ]
    };

    // --- DOM ELEMENTS ---
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const viewerLoginBtn = document.getElementById('viewer-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userNameDisplay = document.getElementById('user-name-display');
    const userRoleDisplay = document.getElementById('user-role-display');
    const dashboardTab = document.getElementById('dashboard-tab');
    const listTab = document.getElementById('list-tab');
    const dashboardView = document.getElementById('dashboard-view');
    const listView = document.getElementById('list-view');
    const modalsContainer = document.getElementById('modals-container');

    // --- DATA HANDLING ---
    const saveToStorage = () => {
        try {
            localStorage.setItem('medicalDevicesData', JSON.stringify(AppState.devices));
        } catch (e) { console.error("Failed to save data", e); }
    };

    const loadFromStorage = () => {
        try {
            const storedData = localStorage.getItem('medicalDevicesData');
            if (storedData) {
                AppState.devices = JSON.parse(storedData);
                // Ensure maintenanceHistory is an array
                AppState.devices.forEach(d => {
                    if (!Array.isArray(d.maintenanceHistory)) {
                        d.maintenanceHistory = [];
                    }
                });
                return;
            }
        } catch(e) { console.error("Failed to load data", e); }
        // Fallback data
        AppState.devices = [
            { id: 'PHY-001', name: 'جهاز الموجات فوق الصوتية', department: 'العلاج الطبيعي', serial: 'SN12345', model: 'US-2000', purchaseDate: '2023-05-15', status: 'فعال', location: 'غرفة 3', supplier: 'شركة الأمل', lastMaintenance: '2025-01-10', maintenanceInterval: '6', nextMaintenance: '2025-07-10', notes: 'يعمل بكفاءة', maintenanceHistory: [{date: '2025-01-10', engineer: 'النظام'}] },
        ];
        saveToStorage();
    };

    // --- UTILITY FUNCTIONS ---
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    };

    const generateDeviceId = (departmentName) => {
        const department = AppState.departments.find(d => d.name === departmentName);
        if (!department) return null;
        const depCode = department.code;
        const devicesInDep = AppState.devices.filter(d => d.id.startsWith(depCode));
        let maxNum = 0;
        devicesInDep.forEach(d => {
            const numPart = parseInt(d.id.split('-')[1], 10);
            if (numPart > maxNum) maxNum = numPart;
        });
        return `${depCode}-${String(maxNum + 1).padStart(3, '0')}`;
    };

    // --- AUTHENTICATION ---
    const handleLogin = (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.toLowerCase();
        const password = document.getElementById('password').value;
        const user = AppState.users[username];

        if (user && user.pass === password) {
            AppState.currentUser = { username, ...user };
            initializeApp();
        } else {
            loginError.classList.remove('hidden');
        }
    };

    const handleViewerLogin = () => {
        AppState.currentUser = { username: 'viewer', name: 'مشرف', role: 'viewer' };
        initializeApp();
    };

    const handleLogout = () => {
        AppState.currentUser = null;
        loginView.classList.remove('hidden');
        appView.classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        loginError.classList.add('hidden');
    };

    // --- UI RENDERING ---
    const renderUIForRole = () => {
        const isEngineer = AppState.currentUser.role === 'engineer';
        document.querySelectorAll('.engineer-only').forEach(el => {
            el.style.display = isEngineer ? '' : 'none';
        });
    };

    const renderDashboard = () => {
        // Stats
        const statsContainer = document.getElementById('stats');
        statsContainer.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-slate-500 font-medium">إجمالي الأجهزة</h3><p class="text-3xl font-bold mt-2 text-blue-600">${AppState.devices.length}</p></div>
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-slate-500 font-medium">أجهزة فعالة</h3><p class="text-3xl font-bold mt-2 text-green-600">${AppState.devices.filter(d => d.status === 'فعال').length}</p></div>
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-slate-500 font-medium">تحتاج صيانة</h3><p class="text-3xl font-bold mt-2 text-amber-500">${AppState.devices.filter(d => d.status === 'يحتاج صيانة').length}</p></div>
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-slate-500 font-medium">خارج الخدمة</h3><p class="text-3xl font-bold mt-2 text-red-600">${AppState.devices.filter(d => d.status === 'خارج الخدمة').length}</p></div>
        `;

        // Charts
        const visualsContainer = document.getElementById('visuals');
        visualsContainer.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-bold mb-4 text-center">توزيع الأجهزة على الأقسام</h3><div class="h-80"><canvas id="department-chart"></canvas></div></div>
            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-bold mb-4 text-center">حالة الأجهزة</h3><div class="h-80"><canvas id="status-chart"></canvas></div></div>
        `;
        renderCharts();
        renderMaintenanceToday();
    };

    const renderCharts = () => {
        // Department Chart
        const depCtx = document.getElementById('department-chart').getContext('2d');
        const depCounts = AppState.departments.map(dep => ({ name: dep.name, count: AppState.devices.filter(d => d.department === dep.name).length }));
        new Chart(depCtx, { type: 'bar', data: { labels: depCounts.map(d => d.name), datasets: [{ label: 'عدد الأجهزة', data: depCounts.map(d => d.count), backgroundColor: 'rgba(59, 130, 246, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });

        // Status Chart
        const statusCtx = document.getElementById('status-chart').getContext('2d');
        const statusCounts = { 'فعال': 0, 'يحتاج صيانة': 0, 'خارج الخدمة': 0 };
        AppState.devices.forEach(d => { if(statusCounts.hasOwnProperty(d.status)) statusCounts[d.status]++; });
        new Chart(statusCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    };
    
    const renderMaintenanceToday = () => {
        const listEl = document.getElementById('maintenance-today-list');
        const noItemsEl = document.getElementById('no-maintenance-today');
        listEl.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];

        const devicesForMaintenance = AppState.devices.filter(d => d.nextMaintenance === today);
        noItemsEl.style.display = devicesForMaintenance.length > 0 ? 'none' : 'block';

        devicesForMaintenance.forEach(device => {
            const lastMaint = device.maintenanceHistory.slice(-1)[0];
            const lastEngineer = lastMaint ? lastMaint.engineer : 'غير مسجل';
            const item = document.createElement('div');
            item.className = 'p-3 bg-blue-50 rounded-lg flex justify-between items-center';
            item.innerHTML = `
                <div>
                    <p class="font-bold text-slate-800">${device.name} <span class="text-sm font-normal text-slate-500">(${device.id})</span></p>
                    <p class="text-sm text-slate-600">القسم: ${device.department} | آخر صيانة بواسطة: ${lastEngineer}</p>
                </div>
                <button data-id="${device.id}" class="details-btn font-medium text-blue-600 hover:underline">عرض التفاصيل</button>
            `;
            listEl.appendChild(item);
        });
    };

    const renderDeviceList = () => {
        listView.innerHTML = `
            <section id="inventory-table" class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold">قائمة الأجهزة</h2>
                    <button id="add-device-btn" class="engineer-only w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ إضافة جهاز جديد</button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="text" id="search-input" placeholder="ابحث..." class="flex-grow p-2 border border-slate-300 rounded-lg">
                    <select id="department-filter" class="p-2 border border-slate-300 rounded-lg"></select>
                    <select id="status-filter" class="p-2 border border-slate-300 rounded-lg">
                        <option value="">كل الحالات</option><option value="فعال">فعال</option><option value="يحتاج صيانة">يحتاج صيانة</option><option value="خارج الخدمة">خارج الخدمة</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th class="px-6 py-3">كود</th><th class="px-6 py-3">اسم</th><th class="px-6 py-3">قسم</th>
                                <th class="px-6 py-3">حالة</th><th class="px-6 py-3">صيانة قادمة</th><th class="px-6 py-3">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="devices-tbody"></tbody>
                    </table>
                    <p id="no-results" class="text-center py-8 text-slate-500 hidden">لا توجد نتائج.</p>
                </div>
            </section>
        `;
        // Populate filters and table
        const departmentFilterEl = document.getElementById('department-filter');
        departmentFilterEl.innerHTML = '<option value="">كل الأقسام</option>';
        AppState.departments.forEach(dep => departmentFilterEl.add(new Option(dep.name, dep.name)));
        
        filterAndRenderTable();
        renderUIForRole();
    };

    const filterAndRenderTable = () => {
        const tbody = document.getElementById('devices-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
        const depFilter = document.getElementById('department-filter')?.value || '';
        const statFilter = document.getElementById('status-filter')?.value || '';

        const filtered = AppState.devices.filter(d => 
            (d.name.toLowerCase().includes(searchTerm) || d.serial?.toLowerCase().includes(searchTerm)) &&
            (!depFilter || d.department === depFilter) &&
            (!statFilter || d.status === statFilter)
        );

        document.getElementById('no-results').style.display = filtered.length > 0 ? 'none' : 'block';
        
        filtered.forEach(device => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white border-b hover:bg-slate-50';
            tr.innerHTML = `
                <td class="px-6 py-4 font-medium text-slate-900">${device.id}</td>
                <td class="px-6 py-4">${device.name}</td>
                <td class="px-6 py-4">${device.department}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${device.status === 'فعال' ? 'bg-green-100 text-green-800' : device.status === 'يحتاج صيانة' ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-800'}">${device.status}</span></td>
                <td class="px-6 py-4">${formatDate(device.nextMaintenance)}</td>
                <td class="px-6 py-4"><button data-id="${device.id}" class="details-btn font-medium text-blue-600 hover:underline">تفاصيل</button></td>
            `;
            tbody.appendChild(tr);
        });
    };

    const openModal = (modalHTML) => {
        modalsContainer.innerHTML = modalHTML;
        const modal = modalsContainer.firstElementChild;
        modal.classList.remove('hidden');
        // Attach close events
        modal.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.onclick = () => modalsContainer.innerHTML = '';
        });
        modal.onclick = (e) => {
            if (e.target === modal) modalsContainer.innerHTML = '';
        };
    };

    const openEditModal = (device = null) => {
        const isEdit = device !== null;
        const title = isEdit ? 'تعديل بيانات الجهاز' : 'إضافة جهاز جديد';
        const modalHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <form id="device-form" class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">${title}</h2>
                            <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                        </div>
                        <input type="hidden" id="device-id-hidden" value="${isEdit ? device.id : ''}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block mb-2 text-sm font-medium">اسم الجهاز</label><input type="text" id="deviceName" class="w-full p-2.5 border rounded-lg" value="${isEdit ? device.name : ''}" required></div>
                            <div><label class="block mb-2 text-sm font-medium">القسم</label><select id="department" class="w-full p-2.5 border rounded-lg" required>${AppState.departments.map(d => `<option value="${d.name}" ${isEdit && d.name === device.department ? 'selected' : ''}>${d.name}</option>`).join('')}</select></div>
                            <div><label class="block mb-2 text-sm font-medium">الرقم التسلسلي</label><input type="text" id="serialNumber" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.serial ? device.serial : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">الموديل</label><input type="text" id="model" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.model ? device.model : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">تاريخ الشراء</label><input type="date" id="purchaseDate" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.purchaseDate ? device.purchaseDate : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">الحالة</label><select id="status" class="w-full p-2.5 border rounded-lg" required><option value="فعال" ${isEdit && device.status === 'فعال' ? 'selected' : ''}>فعال</option><option value="يحتاج صيانة" ${isEdit && device.status === 'يحتاج صيانة' ? 'selected' : ''}>يحتاج صيانة</option><option value="خارج الخدمة" ${isEdit && device.status === 'خارج الخدمة' ? 'selected' : ''}>خارج الخدمة</option></select></div>
                            <div><label class="block mb-2 text-sm font-medium">الموقع</label><input type="text" id="location" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.location ? device.location : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">المورد</label><input type="text" id="supplier" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.supplier ? device.supplier : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">تاريخ آخر صيانة</label><input type="date" id="lastMaintenanceDate" class="w-full p-2.5 border rounded-lg" value="${isEdit && device.lastMaintenance ? device.lastMaintenance : ''}"></div>
                            <div><label class="block mb-2 text-sm font-medium">فترة الصيانة</label><select id="maintenanceInterval" class="w-full p-2.5 border rounded-lg"><option value="">بدون</option><option value="1" ${isEdit && device.maintenanceInterval == 1 ? 'selected' : ''}>شهر</option><option value="3" ${isEdit && device.maintenanceInterval == 3 ? 'selected' : ''}>3 أشهر</option><option value="6" ${isEdit && device.maintenanceInterval == 6 ? 'selected' : ''}>6 أشهر</option><option value="12" ${isEdit && device.maintenanceInterval == 12 ? 'selected' : ''}>سنوي</option></select></div>
                            <div class="md:col-span-2"><label class="block mb-2 text-sm font-medium">الصيانة القادمة</label><input type="date" id="nextMaintenanceDate" class="w-full p-2.5 bg-slate-200 border rounded-lg" value="${isEdit && device.nextMaintenance ? device.nextMaintenance : ''}" readonly></div>
                            <div class="md:col-span-2"><label class="block mb-2 text-sm font-medium">ملاحظات</label><textarea id="notes" rows="3" class="w-full p-2.5 border rounded-lg">${isEdit && device.notes ? device.notes : ''}</textarea></div>
                        </div>
                        <div class="mt-8 flex justify-end gap-4">
                            <button type="button" class="close-modal-btn py-2 px-4 bg-slate-200 rounded-lg">إلغاء</button>
                            <button type="submit" class="py-2 px-6 bg-blue-600 text-white font-bold rounded-lg">حفظ</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        openModal(modalHTML);

        // Add event listeners for automatic date calculation
        const lastMaintField = document.getElementById('lastMaintenanceDate');
        const intervalField = document.getElementById('maintenanceInterval');
        const nextMaintField = document.getElementById('nextMaintenanceDate');
        const calculateNext = () => {
            if (lastMaintField.value && intervalField.value) {
                const date = new Date(lastMaintField.value);
                date.setMonth(date.getMonth() + parseInt(intervalField.value, 10));
                nextMaintField.value = date.toISOString().split('T')[0];
            } else {
                nextMaintField.value = '';
            }
        };
        lastMaintField.onchange = calculateNext;
        intervalField.onchange = calculateNext;

        // Form submission
        document.getElementById('device-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('device-id-hidden').value;
            const lastMaintenanceDate = document.getElementById('lastMaintenanceDate').value;
            
            const formData = {
                name: document.getElementById('deviceName').value, department: document.getElementById('department').value,
                serial: document.getElementById('serialNumber').value, model: document.getElementById('model').value,
                purchaseDate: document.getElementById('purchaseDate').value, status: document.getElementById('status').value,
                location: document.getElementById('location').value, supplier: document.getElementById('supplier').value,
                lastMaintenance: lastMaintenanceDate,
                maintenanceInterval: document.getElementById('maintenanceInterval').value,
                nextMaintenance: document.getElementById('nextMaintenanceDate').value,
                notes: document.getElementById('notes').value,
                maintenanceHistory: isEdit ? device.maintenanceHistory : []
            };

            if (isEdit) {
                const index = AppState.devices.findIndex(d => d.id === id);
                // Check if last maintenance date has changed to add a log entry
                if (lastMaintenanceDate && device.lastMaintenance !== lastMaintenanceDate) {
                    formData.maintenanceHistory.push({ date: lastMaintenanceDate, engineer: AppState.currentUser.name });
                }
                AppState.devices[index] = { ...AppState.devices[index], ...formData, id: id };
            } else {
                formData.id = generateDeviceId(formData.department);
                if (lastMaintenanceDate) {
                    formData.maintenanceHistory.push({ date: lastMaintenanceDate, engineer: AppState.currentUser.name });
                }
                AppState.devices.push(formData);
            }
            
            saveToStorage();
            fullRender();
            modalsContainer.innerHTML = ''; // Close modal
        };
    };

    const openViewModal = (device) => {
        const historyHTML = device.maintenanceHistory.map(h => `
            <li class="flex justify-between items-center text-sm p-2 bg-slate-50 rounded">
                <span><i class="fa-solid fa-calendar-check ml-2"></i>${formatDate(h.date)}</span>
                <span><i class="fa-solid fa-user-gear ml-2"></i>${h.engineer}</span>
            </li>
        `).join('');

        const modalHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">${device.name}</h2>
                            <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Info -->
                            <div class="md:col-span-2 space-y-3">
                                <p><strong>الكود:</strong> ${device.id}</p>
                                <p><strong>الرقم التسلسلي:</strong> ${device.serial || 'N/A'}</p>
                                <p><strong>القسم:</strong> ${device.department}</p>
                                <p><strong>الحالة:</strong> ${device.status}</p>
                                <p><strong>تاريخ الشراء:</strong> ${formatDate(device.purchaseDate)}</p>
                                <p><strong>المورد:</strong> ${device.supplier || 'N/A'}</p>
                                <p><strong>الصيانة الدورية:</strong> ${device.maintenanceInterval ? `كل ${device.maintenanceInterval} أشهر` : 'غير محدد'}</p>
                                <p><strong>الصيانة القادمة:</strong> ${formatDate(device.nextMaintenance)}</p>
                                <div class="pt-4">
                                    <h4 class="font-bold mb-2">سجل الصيانة</h4>
                                    <ul class="space-y-2 max-h-40 overflow-y-auto pr-2">${historyHTML || '<p class="text-slate-500">لا يوجد سجل.</p>'}</ul>
                                </div>
                            </div>
                            <!-- QR -->
                            <div class="bg-slate-50 rounded-lg p-4 flex flex-col items-center justify-center">
                                <h3 class="font-bold mb-2">رمز QR</h3>
                                <div id="view-qrcode-container" class="p-2 bg-white border rounded-md"></div>
                                <p class="text-sm text-slate-500 mt-2">امسح لطلب صيانة</p>
                                <button id="print-sticker-btn" class="mt-4 py-2 px-4 bg-slate-600 text-white rounded-lg"><i class="fas fa-print mr-2"></i>طباعة الملصق</button>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t flex justify-end gap-4 engineer-only">
                             <button id="delete-device-btn" class="py-2 px-6 bg-red-600 text-white font-bold rounded-lg">حذف</button>
                             <button id="edit-device-btn" class="py-2 px-6 bg-blue-600 text-white font-bold rounded-lg">تعديل</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        openModal(modalHTML);
        renderUIForRole(); // Apply role permissions to the modal

        // Generate QR
        const whatsAppNumber = "972567090858";
        const message = `عطل بالجهاز: ${device.id}\nالمشكلة: `;
        const whatsappUrl = `https://wa.me/${whatsAppNumber}?text=${encodeURIComponent(message)}`;
        new QRCode(document.getElementById('view-qrcode-container'), { text: whatsappUrl, width: 150, height: 150, correctLevel : QRCode.CorrectLevel.L });
        
        // Add event listeners for modal buttons
        document.getElementById('edit-device-btn')?.addEventListener('click', () => openEditModal(device));
        document.getElementById('delete-device-btn')?.addEventListener('click', () => openDeleteModal(device.id));
        document.getElementById('print-sticker-btn').addEventListener('click', () => printSticker(device));
    };
    
    const openDeleteModal = (deviceId) => {
        const modalHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                    <div class="p-6 text-center">
                        <i class="fas fa-exclamation-triangle text-5xl text-amber-500 mb-4"></i>
                        <h3 class="text-xl font-bold">تأكيد الحذف</h3>
                        <p class="text-slate-600 my-2">هل أنت متأكد أنك تريد حذف هذا الجهاز؟</p>
                    </div>
                    <div class="flex justify-center gap-4 bg-slate-50 p-4 rounded-b-xl">
                        <button class="close-modal-btn py-2 px-6 bg-slate-200 rounded-lg">إلغاء</button>
                        <button id="confirm-delete-btn" class="py-2 px-6 bg-red-600 text-white font-bold rounded-lg">نعم، احذف</button>
                    </div>
                </div>
            </div>
        `;
        openModal(modalHTML);
        document.getElementById('confirm-delete-btn').onclick = () => {
            AppState.devices = AppState.devices.filter(d => d.id !== deviceId);
            saveToStorage();
            fullRender();
            modalsContainer.innerHTML = '';
        };
    };

    const printSticker = (device) => {
        const stickerArea = document.getElementById('sticker-print-area');
        stickerArea.innerHTML = `
            <div style="width: 7cm; height: 5cm; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; justify-content: space-between; padding: 8px; box-sizing: border-box; background-color: white; border: 1px solid #ccc;">
                <div style="text-align: center;"><img src="logo.png" style="height: 2.2cm; width: auto; object-fit: contain;"></div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%;">
                    <div style="color: black; text-align: right;">
                        <p style="font-size: 10pt; font-weight: bold; margin: 0; line-height: 1.2;">مجمع الصحابة الطبي</p>
                        <hr style="border-top: 1px solid #555; margin: 3px 0;">
                        <p style="font-size: 11pt; font-weight: 900; margin: 0; line-height: 1.2;">ID: ${device.id}</p>
                        <p style="font-size: 9pt; margin: 0; line-height: 1.2;">القسم: ${device.department}</p>
                        <p style="font-size: 9pt; margin: 0; line-height: 1.2;">الموقع: ${device.location || 'غير محدد'}</p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: black;">
                        <div id="sticker-qrcode-container" style="padding: 2px; background: white;"></div>
                        <p style="font-size: 7pt; margin-top: 2px; text-align: center;">امسح لطلب صيانة</p>
                    </div>
                </div>
            </div>
        `;
        const whatsAppNumber = "972567090858";
        const message = `عطل بالجهاز: ${device.id}\nالمشكلة: `;
        const whatsappUrl = `https://wa.me/${whatsAppNumber}?text=${encodeURIComponent(message)}`;
        new QRCode(document.getElementById('sticker-qrcode-container'), { text: whatsappUrl, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L });
        window.print();
    };


    // --- INITIALIZATION & EVENT LISTENERS ---
    const fullRender = () => {
        if (dashboardView.style.display !== 'none') {
            renderDashboard();
        }
        if (listView.style.display !== 'none') {
            renderDeviceList();
        }
    };

    const initializeApp = () => {
        loginView.classList.add('hidden');
        appView.classList.remove('hidden');
        userNameDisplay.textContent = AppState.currentUser.name;
        userRoleDisplay.textContent = AppState.currentUser.role === 'engineer' ? 'مهندس' : 'مشرف';
        loadFromStorage();
        renderDashboard(); // Initial view is dashboard
        renderUIForRole();
    };

    // Global Event Listeners
    loginForm.addEventListener('submit', handleLogin);
    viewerLoginBtn.addEventListener('click', handleViewerLogin);
    logoutBtn.addEventListener('click', handleLogout);

    dashboardTab.addEventListener('click', () => {
        dashboardTab.classList.add('active');
        listTab.classList.remove('active');
        dashboardView.style.display = 'block';
        listView.style.display = 'none';
        renderDashboard();
    });

    listTab.addEventListener('click', () => {
        listTab.classList.add('active');
        dashboardTab.classList.remove('active');
        listView.style.display = 'block';
        dashboardView.style.display = 'none';
        renderDeviceList();
    });

    // Event delegation for dynamically created elements
    document.body.addEventListener('click', (e) => {
        if (e.target.matches('.details-btn')) {
            const device = AppState.devices.find(d => d.id === e.target.dataset.id);
            if (device) openViewModal(device);
        }
        if (e.target.matches('#add-device-btn')) {
            openEditModal();
        }
    });
    
    document.body.addEventListener('input', (e) => {
        if (e.target.matches('#search-input, #department-filter, #status-filter')) {
            filterAndRenderTable();
        }
    });

});
</script>

</body>
</html>
